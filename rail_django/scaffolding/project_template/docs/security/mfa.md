# Multi-Factor Authentication (MFA)

## Overview

Rail Django integrates a multi-factor authentication (MFA) system based on TOTP (Time-based One-Time Password) compatible with standard authenticator apps (Google Authenticator, Authy, Microsoft Authenticator).

---

## Table of Contents

1. [Configuration](#configuration)
2. [TOTP Setup Flow](#totp-setup-flow)
3. [GraphQL Mutations](#graphql-mutations)
4. [MFA Enforcement](#mfa-enforcement)
5. [Best Practices](#best-practices)

---

## Configuration

### MFA Settings

```python
# root/settings/base.py
RAIL_DJANGO_GRAPHQL = {
    "schema_settings": {
        # Enables MFA mutations
        "enable_extension_mutations": True,
    },
    "mfa_settings": {
        "enabled": True,
        # Number of TOTP code digits
        "totp_digits": 6,
        # Validity interval in seconds
        "totp_interval": 30,
        # Tolerance (number of periods before/after)
        "totp_tolerance": 1,
        # Force MFA for staff users
        "enforce_for_staff": True,
        # Force MFA for superusers
        "enforce_for_superusers": True,
        # Max devices per user
        "max_devices_per_user": 5,
        # Issuer name in auth app
        "issuer_name": "MyApplication",
    },
}
```

---

## TOTP Setup Flow

### Step 1: Initialization

The user requests configuration of a new TOTP device:

```graphql
mutation SetupTotp($deviceName: String!) {
  setupTotp(deviceName: $deviceName) {
    ok
    deviceId # Created device ID (pending verification)
    secret # Secret key (never display directly)
    qrCodeUrl # QR code URL to scan
    provisioningUri # otpauth:// URI for manual import
    errors
  }
}
```

**Variables:**

```json
{
  "deviceName": "My iPhone"
}
```

**Response:**

```json
{
  "data": {
    "setupTotp": {
      "ok": true,
      "deviceId": "1",
      "secret": "JBSWY3DPEHPK3PXP",
      "qrCodeUrl": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUg...",
      "provisioningUri": "otpauth://totp/MyApplication:john.doe?secret=JBSWY3DPEHPK3PXP&issuer=MyApplication",
      "errors": null
    }
  }
}
```

### Step 2: QR Code Display

Display the QR code for the user to scan with their authenticator app:

```html
<img
  src="{{ qr_code_url }}"
  alt="Scan this QR code with your authenticator app"
/>

<!-- Alternative: manual URI -->
<p>Or manually enter this key: <code>{{ secret }}</code></p>
```

### Step 3: Verification

The user enters the code generated by their app to confirm the configuration:

```graphql
mutation VerifyTotp($deviceId: ID!, $token: String!) {
  verifyTotp(deviceId: $deviceId, token: $token) {
    ok
    device {
      id
      name
      confirmed # true after successful verification
      createdAt
    }
    backupCodes # Backup codes (to save)
    errors
  }
}
```

**Variables:**

```json
{
  "deviceId": "1",
  "token": "123456"
}
```

**Success Response:**

```json
{
  "data": {
    "verifyTotp": {
      "ok": true,
      "device": {
        "id": "1",
        "name": "My iPhone",
        "confirmed": true,
        "createdAt": "2026-01-16T10:30:00Z"
      },
      "backupCodes": ["ABCD-1234-EFGH", "IJKL-5678-MNOP", "QRST-9012-UVWX"],
      "errors": null
    }
  }
}
```

---

## GraphQL Mutations

### List MFA Devices

```graphql
query MyMfaDevices {
  myMfaDevices {
    id
    name
    confirmed
    lastUsedAt
    createdAt
  }
}
```

### Remove a Device

```graphql
mutation RemoveMfaDevice($deviceId: ID!) {
  removeMfaDevice(deviceId: $deviceId) {
    ok
    errors
  }
}
```

### Login Verification

If MFA is enabled, the `login` mutation returns `mfaRequired: true`:

```graphql
mutation Login($username: String!, $password: String!) {
  login(username: $username, password: $password) {
    ok
    mfaRequired # true if user has MFA devices
    mfaSessionToken # Temporary token for MFA verification
    token # null if mfaRequired
    errors
  }
}
```

Then the user must complete with MFA verification:

```graphql
mutation CompleteMfaLogin($sessionToken: String!, $totpCode: String!) {
  completeMfaLogin(sessionToken: $sessionToken, totpCode: $totpCode) {
    ok
    token # Final JWT token
    refreshToken
    user {
      id
      username
    }
    errors
  }
}
```

### Using Backup Codes

If the user doesn't have access to their device:

```graphql
mutation CompleteMfaLogin($sessionToken: String!, $backupCode: String!) {
  completeMfaLogin(sessionToken: $sessionToken, backupCode: $backupCode) {
    ok
    token
    remainingBackupCodes # Number of remaining codes
    errors
  }
}
```

### Regenerate Backup Codes

```graphql
mutation RegenerateBackupCodes($totpCode: String!) {
  regenerateBackupCodes(totpCode: $totpCode) {
    ok
    backupCodes # New codes (old ones are invalidated)
    errors
  }
}
```

---

## MFA Enforcement

### Enforcement Middleware

When MFA is enforced, users without a configured MFA device are blocked on sensitive mutations:

```python
RAIL_DJANGO_GRAPHQL = {
    "mfa_settings": {
        "enforce_for_staff": True,
        # List of mutations allowed without MFA
        "exempt_mutations": [
            "setup_totp",
            "verify_totp",
            "logout",
        ],
    },
}
```

### Verification in Resolvers

```python
from rail_django.extensions.auth import require_mfa

@require_mfa
def resolve_sensitive_operation(root, info, **kwargs):
    """
    This operation requires the user to have MFA enabled.
    """
    # ... sensitive logic
```

### MFA Status Query

```graphql
query MfaStatus {
  me {
    id
    username
    mfaEnabled # true if at least one confirmed device
    mfaDevicesCount
    mfaRequired # true if enforcement applies
  }
}
```

---

## Best Practices

### 1. Backup Code Storage

Display backup codes only once and ask the user to save them:

```html
<div class="backup-codes-warning">
  <h3>‚ö†Ô∏è Save these backup codes</h3>
  <p>These codes will not be displayed again. Keep them in a safe place.</p>
  <ul>
    {{#each backupCodes}}
    <li><code>{{ this }}</code></li>
    {{/each}}
  </ul>
  <button onclick="window.print()">Print</button>
</div>
```

### 2. Device Count

Allow multiple devices to avoid access issues:

```python
"mfa_settings": {
    "max_devices_per_user": 3,  # Allows a backup
}
```

### 3. Grace Period

Grant a delay to configure MFA after enforcement activation:

```python
"mfa_settings": {
    "enforcement_grace_period_hours": 24,
}
```

### 4. MFA Event Logging

```python
"mfa_settings": {
    "log_mfa_events": True,  # Log successes/failures
},
```

üìñ MFA events are tracked in the audit system. See [Audit & Logging](../extensions/audit.md).

---

## See Also

- [JWT Authentication](./authentication.md)
- [Permissions & RBAC](./permissions.md)
- [Audit & Logging](../extensions/audit.md)
