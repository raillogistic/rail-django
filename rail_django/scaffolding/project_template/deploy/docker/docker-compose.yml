version: '3.8'

services:
  web:
    build:
      context: ../../
      dockerfile: deploy/docker/Dockerfile
    restart: unless-stopped
    volumes:
      - static_volume:/home/app/web/staticfiles
      - ${MEDIA_PATH:-../../media}:/home/app/web/mediafiles
      - ${LOG_PATH:-../../logs}:/home/app/web/logs
    expose:
      - 8000
    env_file:
      - ../../.env
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.connect(('127.0.0.1', 8000)); s.close()\""]
      interval: 30s
      timeout: 5s
      retries: 3

  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    volumes:
      - static_volume:/app/staticfiles
      - ${MEDIA_PATH:-../../media}:/app/mediafiles
      - ../nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ../nginx/certs:/etc/nginx/certs:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - web

  backup:
    image: postgres:15-alpine
    restart: unless-stopped
    volumes:
      - ${BACKUP_PATH:-../../backups}:/backups
      - ./backup.sh:/usr/local/bin/backup.sh
    command: sh /usr/local/bin/backup.sh
    env_file:
      - ../../.env

volumes:
  static_volume:
