# Type generator internals

> **Module path:** `rail_django.generators.types.generator`

`TypeGenerator` is the model-to-type bridge used by Rail Django. It builds
GraphQL object types, mutation input types, and optional `django-filter`
filtersets, and it applies field policy from `GraphQLMeta`.

## Constructor and settings

Create one generator per schema.

```python
from rail_django.generators.types import TypeGenerator

type_gen = TypeGenerator(schema_name="default")
```

Constructor arguments:

- `settings: TypeGeneratorSettings | None`
- `mutation_settings: MutationGeneratorSettings | None`
- `schema_name: str = "default"`

When settings are omitted, the generator loads schema-scoped settings via
`TypeGeneratorSettings.from_schema(...)` and
`MutationGeneratorSettings.from_schema(...)`.

## Public generation methods

These methods are the main API.

| Method | Returns | Notes |
|---|---|---|
| `generate_object_type(model)` | `DjangoObjectType` subclass | Cached per model |
| `generate_input_type(model, ...)` | `InputObjectType` subclass | Cached by model + options |
| `generate_filter_type(model)` | `FilterSet` subclass or `None` | Requires `django-filter` and `generate_filters=True` |
| `handle_custom_fields(field)` | Graphene scalar type | Fallback for unmapped custom fields |

## Object type behavior

Object generation includes more than plain model fields.

- Respects include/exclude/read-write field policy from `GraphQLMeta`.
- Adds `pk` and `desc` helper fields.
- Adds `row_permissions` metadata (`can_update`, `can_delete`, reasons).
- Adds reverse relation fields and `<relation>_count`.
- Adds `<relation>_stats` for numeric aggregates on reverse relations.
- Adds `<field>_desc` for choice fields.
- Applies tenant scoping in relation resolvers.
- Uses DataLoader for eligible reverse many-to-one relations.

The generator excludes `polymorphic_ctype` and inheritance pointer fields
(`*_ptr`) automatically.

## Input type behavior

Input generation supports both top-level fields and nested relation operations.

```python
CreateInput = type_gen.generate_input_type(Product, mutation_type="create")
UpdateInput = type_gen.generate_input_type(
    Product,
    mutation_type="update",
    partial=True,
)
```

Key behavior:

- For `create`, requiredness follows model null/default/blank semantics.
- For `update`, non-ID fields stay optional to support partial updates.
- Read-only fields are excluded from input generation.
- Reverse relations can be included unless disabled.

### Unified relation inputs

Relation inputs are generated by `RelationInputTypeGenerator` with operations:

- `connect`
- `disconnect` (list relations)
- `set` (list relations)
- `create`
- `update`

`GraphQLMeta.relations` can disable specific operations per field. If relation
style is `id_only`, nested `create` and `update` are disabled.

## Filter type behavior

`generate_filter_type(model)` builds a `FilterSet` from model fields and then
intersects it with `GraphQLMeta.filtering.fields` lookups when provided.

Lookup normalization supports these aliases:

- `eq -> exact`
- `is_null -> isnull`
- `between -> range`
- `starts_with -> startswith`
- `istarts_with -> istartswith`
- `ends_with -> endswith`
- `iends_with -> iendswith`

If `django-filter` is not installed or `generate_filters` is disabled, this
method returns `None`.

## Scalar and custom field mapping

Field-to-GraphQL mapping starts from built-in defaults, then applies:

1. `settings.custom_field_mappings`
2. enabled custom scalars (`Email`, `URL`, `UUID`, `DateTime`, `Date`, `Time`,
   `JSON`, `Decimal`, `Binary`)

Unknown custom model fields fall back to `handle_custom_fields(...)`.

## Caching and registries

Generated artifacts are cached to avoid duplicate classes:

- `_type_registry`
- `_input_type_registry`
- `_filter_type_registry`
- `_enum_registry`
- `_meta_cache`

Treat these as internal caches, not stable public API.

## Settings reference

`TypeGeneratorSettings` fields:

- `exclude_fields`
- `excluded_fields`
- `include_fields`
- `custom_field_mappings`
- `generate_filters`
- `enable_filtering`
- `auto_camelcase`
- `generate_descriptions`

## Usage example

```python
from rail_django.generators.types import TypeGenerator
from myapp.models import Product

type_gen = TypeGenerator(schema_name="default")

ProductType = type_gen.generate_object_type(Product)
CreateProductInput = type_gen.generate_input_type(Product, mutation_type="create")
UpdateProductInput = type_gen.generate_input_type(
    Product, mutation_type="update", partial=True
)
ProductFilter = type_gen.generate_filter_type(Product)
```

## Related pages

- [GraphQLMeta](../core/graphql-meta.md)
- [Query generator](./query-generator.md)
- [Mutation generator](./mutation-generator.md)
